# Рефлектори в will-файлах

В керівництві користувача описуються рефлектори - призначення, особливості побудови, використання

Зміст керівництва  
[Поняття рефлектора](#reflector-term)  
[Структура рефлектора](#reflector-structure)  
- [Шляхи](#reflector-paths)  
- [Маски рефлектора](#reflector-masks)  
- [Фільтри рефлектора](#reflector-filter)  

[Приклади використання](#examples)  

### <a name="reflector-term"></a> Поняття рефлектора  
Рефлектор - це не тільки назва секції, чи одна функція пакета `willbe`, а набір функціональностей для ефективного управління файловими ресурсами модульної системи. Основними функціями є сортування, групування файлів, зчитування, копіювання та переміщення.

### <a name="reflector-resource-structure"></a> Структура ресурсу рефлектора 
Ресурс рефлектора, як і інших складається з набору полів. До стандартних відносяться `description` - опис рефлектора, `criterion` - для порівняння мапи критеріонів при виборі рефлектора, `inherit` - наслідування користувацьких збірок або вбудованих рефлекторів. Є ще чотири унікальних поля: `recursive` - замикання процедури вибору файлів на себе з умовою виходу; `filePath` - шлях до файлів модуля; `src` - ресурси (шляхи) звідки буде зчитано файли; `dst` - директорія в яку будут поміщено файли.  
Поля `filePath`, `src`, `dst` мають ресурси які структурно розділені на шляхи, маски і фільтри.  
Дослідимо структуру і формат ресурсів.  

##### <a name="reflector-paths"></a> Шляхи 
Використовується поля `basePath`, `prefixPath` i `filePath`.  

`basePath` - базовий, основний шлях до файлів рефлектора. Подібно до шляху `in` в секції `step`, задає початкову точку відліку для шляхів. Може включати декілька базових шляхів для різних файлів. Зазвичай позначає поточну директорію '.' і не вказується полі `src`. Якщо поле `basePath` вказано в `will`-файлі і має значення відмінне від '.', то буде скопійовано `will`-модуль в кореневний каталог `will`-файла відносно вказаного шляху.  

```yaml
src :
  basePath :
    'some/file1' : './dir1'
    'some/file2' : './dir2'
  
```

Вказаний ресурс означає, що для `file1`, який знаходиться за шляхом `/some`, базовий шлях починається з директорії `./dir1` в кореневому каталозі `will`-файла. Для другого файла відповідно базовий шлях починається від директорії `./dir2`.  

`prefixPath` - шлях, який додається до `basePath` при створенні модуля.  
Тобто, якщо в полі вказаний `basePath` незалежно від `prefixPath`, то цей шлях є і базовим, і повним, а якщо разом з `prefixPath`, то до нього потрібно додавати префікс із шляху в `prefixPath`.

```yaml
src :
  basePath : '.'
  prefixPath : 'out/out.debug'
dst :
  filePath : '..'
  
```

Приклад показує, що файли будуть братись в директорії за шляхом `./out/out.debug/`, а поміщені в директорію на рівень вище від кореневої директорії `will`-файла.  

`filePath` - поле може бути незалежним або включеним в ресурси `src` i `dst` та позначає відповідні шляхи до файлів модуля орієнтовно `basePath`. Поле має структуру "ключ-значення", де ключем є шлях до файла, а значенням - його істинність (_true, false_), якщо значення не вказане, то за замовчуванням `true`. Також, значенням може бути інша директорія - виконання операції копіювання.  

```yaml
filePath :
  some/file1 : true
  file2 : false
  
```

В секцію поміщено шляхи до двох файлів відносно `basePath`. `file1` включений і буде використовуватись при створенні модуля, а `file2` - ні. Також, можна записати так:

```yaml
filePath :
  some/file1
  
```

При операції копіювання в поле `filePath` записуються два шляхи:

```yaml
filePath :
  /some/file1 : /dir2/
  
```

Буде скопійовано `file1` до директорії `dir2`.

##### <a name="reflector-masks"></a> Маски рефлектора  
Маски слугують для фільтрування файлових операцій в системі. Фільтрування може проходити на рівні терміналу операційної ситеми або ж в директорії розміщення файлів.  
Рефлектори `willbe` використовують три типи масок:  
`maskDirectory` - маска директорії, фільтрує файлові операції у вказаній директорії;  
`maskTerminal` - маска терміналу операційної системи, фільтрує консольні операції;  
`maskAll` - одночасно фільтрує всі файлові операції.
Маски використовують спеціалізовані поля, які можуть приймати прямі значення або ж синтаксис регулярних виразів JavaScript. До цих полів відносяться:
`includeAny` - включити в вибірку будь-який елемент з вказаним параметром;  
`includeAll` - включити в вибірку всі знайдені елементи з вказаним параметром;  
`excludeAny` - виключити з вибірки будь-який елемент з вказаним параметром;  
`excludeAll` - виключити з вибірки всі елементи з вказаним параметром.
При використанні масок їх запис наступний:

```yaml
maskDirectory :
  includeAll : /\.js$/  
  excludeAny : /\.cson$/  
  
```

Цей запис означає включити виконання всіх операцій для файлів з розширенням '.js', та виключити будь-який з розширенням '.cson' в директорії.  

##### <a name="reflector-filter"></a> Фільтри рефлектора  
Фільтри необхідні для обмеження вибору по часовим критеріям. Рефлектори мають чотири часових фільтра: `notOlder`, `notNewer`, `notOlderAge`, `notNewerAge`. В параметрах полів вносяться значення в мілісекундах (1 с = 1000 мс; 1 год = 3600000 мс).  
`notOlder` - не старше на момент вибірки;  
`notNewer` - не новіше на момент вибірки; 
`notOlderAge` - вік, не старший від встановленого на час проведення процедури;  
`notNewerAge` - вік, не менше від встановленого на час проведення процедури. 
Приклад, де вибираються файли не старіші від 10 с на момент вибірки:

```yaml
notOlder : 10000

```

Почнемо з використання пристих фільтрів - це фільтри, які використовуються для сортування файлів за назвою та розширенням. До простих фільтрів відносяться:  
`begins` - включає в вибірку всі файли в директорії, назва яких починається з указаного в фільтрі слова.  
`ends` - включає в вибірку всі файли, назва яких закінчується на вказане в фільтрі слово.  
`hasExtension` - якщо розширення файла співпадає з вказаним в фільтрі, то файл буде включений в вибірку. Розширення файла може бути складним і пакет `willbe` зчитує його, починаючи з першої крапки в назві файла. Наприклад, файл `somefile.txt.md` має два розширення - `txt` i `md`.  
Фільтри рефлектора поміщаються в поле `src`.  

reflector :

  reflect.copy.:
    recursive: 2
    src:
      filePath:
        .: .
      prefixPath: proto
      begins: 
        - 'pac'
        - 'file'
    dst:
      prefixPath: path::out.*=1
    criterion:
      debug: [ 0,1 ]

Є розбіжність - ми знайшли три файла і один каталог в директорії `release`, а не п'ять файлів. Зверніть увагу, рефлектор пакета `willbe` враховує директорію, де поміщаються файли, в даному випадку, директорію `release`. Також, при використанні фільтра `begins` рефлектор копіює внутрішню структуру в вибраних директоріях.   


### <a name="predefined-reflectors"></a> Вбудовані рефлектори  

| Вбудований рефлектор | Опис                                                 | Структура полів       |
|----------------------|------------------------------------------------------|-----------------------|
| predefined.common    |                                                      |                       |
| predefined.debug     |                                                      |                       |
| predefined.release   |                                                      |                       |